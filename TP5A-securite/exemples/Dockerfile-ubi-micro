# Exemple d'image durcie avec Red Hat UBI Micro
# Image ultra-minimale sans package manager
# Patchs de sécurité réguliers de Red Hat

# Stage 1 : Build avec UBI Minimal qui contient microdnf
FROM registry.access.redhat.com/ubi9/ubi-minimal AS builder

WORKDIR /app

# Installer Python et pip
RUN microdnf install -y python3 python3-pip && \
    microdnf clean all

# Copier et installer les dépendances
COPY requirements.txt .
RUN pip3 install --no-cache-dir --target=/app/deps -r requirements.txt

# Copier l'application
COPY app.py .

# Stage 2 : Runtime avec UBI Micro (pas de package manager)
FROM registry.access.redhat.com/ubi9/ubi-micro

WORKDIR /app

# Copier uniquement Python et les bibliothèques nécessaires
COPY --from=builder /usr/bin/python3 /usr/bin/python3
COPY --from=builder /usr/lib64/python3.9 /usr/lib64/python3.9
COPY --from=builder /usr/lib64/libpython3.9.so* /usr/lib64/

# Copier les dépendances de l'application
COPY --from=builder /app/deps /app/deps
COPY --from=builder /app/app.py .

# Configuration Python
ENV PYTHONPATH=/app/deps

# UBI utilise UID 1001 par défaut
USER 1001

# Port de l'application
EXPOSE 5000

# Commande de démarrage
CMD ["/usr/bin/python3", "app.py"]
