name: Test Podman Workshop

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # Détection des changements pour exécuter uniquement les tests nécessaires
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      tp1: ${{ steps.filter.outputs.tp1 }}
      tp2: ${{ steps.filter.outputs.tp2 }}
      tp3: ${{ steps.filter.outputs.tp3 }}
      tp5a: ${{ steps.filter.outputs.tp5a }}
      tp6: ${{ steps.filter.outputs.tp6 }}
      scripts: ${{ steps.filter.outputs.scripts }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for file changes
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            tp1:
              - 'TP1-conteneurs-simples/**'
            tp2:
              - 'TP2-dockerfile/**'
            tp3:
              - 'TP3-compose/**'
            tp5a:
              - 'TP5A-securite/**'
            tp6:
              - 'TP6-projet-complet/**'
            scripts:
              - 'scripts/**'
              - 'lib/**'

  prerequisites:
    name: Check Prerequisites
    runs-on: ubuntu-latest
    needs: changes
    if: |
      needs.changes.outputs.scripts == 'true' ||
      needs.changes.outputs.tp1 == 'true' ||
      needs.changes.outputs.tp2 == 'true' ||
      needs.changes.outputs.tp3 == 'true' ||
      needs.changes.outputs.tp5a == 'true' ||
      needs.changes.outputs.tp6 == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Check Prerequisites
        run: |
          chmod +x scripts/check-prerequisites.sh
          bash scripts/check-prerequisites.sh

  test-tp1:
    name: Test TP1 - Conteneurs Simples
    runs-on: ubuntu-latest
    needs: [changes, prerequisites]
    if: needs.changes.outputs.tp1 == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman curl

      - name: Run TP1 Quick Test
        run: |
          cd TP1-conteneurs-simples/exercices
          chmod +x quick-test.sh
          bash quick-test.sh

  test-tp2:
    name: Test TP2 - Dockerfiles
    runs-on: ubuntu-latest
    needs: [changes, prerequisites]
    if: needs.changes.outputs.tp2 == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman curl

      - name: Run TP2 Tests
        run: |
          cd TP2-dockerfile
          chmod +x test-all-examples.sh
          bash test-all-examples.sh

  test-tp3:
    name: Test TP3 - Podman Compose
    runs-on: ubuntu-latest
    needs: [changes, prerequisites]
    if: needs.changes.outputs.tp3 == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Podman and Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y podman python3-pip curl
          pip3 install podman-compose

      - name: Run TP3 Tests
        run: |
          cd TP3-compose
          chmod +x test-all-stacks.sh
          bash test-all-stacks.sh

  test-security-scripts:
    name: Test TP5A - Security Scripts
    runs-on: ubuntu-latest
    needs: [changes, prerequisites]
    if: needs.changes.outputs.tp5a == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Test Rootless Script
        run: |
          cd TP5A-securite/scripts
          chmod +x test-rootless.sh
          bash test-rootless.sh

      - name: Test Capabilities Script
        run: |
          cd TP5A-securite/scripts
          chmod +x test-capabilities.sh
          bash test-capabilities.sh

  test-tp6:
    name: Test TP6 - Projet Complet
    runs-on: ubuntu-latest
    needs: [changes, prerequisites]
    if: needs.changes.outputs.tp6 == 'true'
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Podman and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y podman python3-pip curl openssl
          pip3 install podman-compose

      - name: Run TP6 Full Stack Test
        run: |
          cd TP6-projet-complet
          chmod +x test-tp6.sh
          bash test-tp6.sh
